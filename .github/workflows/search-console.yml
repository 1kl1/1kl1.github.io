# Google Search Console ìžë™ ì—…ë°ì´íŠ¸ ì›Œí¬í”Œë¡œìš°
name: Update Google Search Console

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.md'
      - '**/*.html'
      - 'sitemap.xml'
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (UTC ê¸°ì¤€)
    - cron: '0 9 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-search-console:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Python dependencies
      run: |
        pip install google-api-python-client google-auth google-auth-oauthlib google-auth-httplib2
        
    - name: Create service account key file
      run: |
        echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}' > service-account-key.json
        
    - name: Submit sitemap to Google Search Console
      run: |
        python << 'EOF'
        import json
        import os
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        
        # ì„œë¹„ìŠ¤ ê³„ì • ì¸ì¦
        SCOPES = ['https://www.googleapis.com/auth/webmasters']
        SERVICE_ACCOUNT_FILE = 'service-account-key.json'
        
        credentials = service_account.Credentials.from_service_account_file(
            SERVICE_ACCOUNT_FILE, scopes=SCOPES)
        
        service = build('searchconsole', 'v1', credentials=credentials)
        
        # ì‚¬ì´íŠ¸ URLê³¼ ì‚¬ì´íŠ¸ë§µ URL ì„¤ì •
        site_url = '${{ secrets.SITE_URL }}'  # ì˜ˆ: https://example.com/
        sitemap_url = f'{site_url}sitemap.xml'
        
        try:
            # ì‚¬ì´íŠ¸ë§µ ì œì¶œ
            request = service.sitemaps().submit(
                siteUrl=site_url,
                feedpath=sitemap_url
            )
            response = request.execute()
            print(f"âœ… ì‚¬ì´íŠ¸ë§µ ì œì¶œ ì„±ê³µ: {sitemap_url}")
            
        except Exception as e:
            print(f"âŒ ì‚¬ì´íŠ¸ë§µ ì œì¶œ ì‹¤íŒ¨: {str(e)}")
            
        # ì‚¬ì´íŠ¸ë§µ ìƒíƒœ í™•ì¸
        try:
            sitemaps = service.sitemaps().list(siteUrl=site_url).execute()
            if 'sitemap' in sitemaps:
                for sitemap in sitemaps['sitemap']:
                    print(f"ðŸ“Š ì‚¬ì´íŠ¸ë§µ: {sitemap['path']}")
                    if 'lastSubmitted' in sitemap:
                        print(f"   ë§ˆì§€ë§‰ ì œì¶œ: {sitemap['lastSubmitted']}")
                    if 'lastDownloaded' in sitemap:
                        print(f"   ë§ˆì§€ë§‰ ë‹¤ìš´ë¡œë“œ: {sitemap['lastDownloaded']}")
        except Exception as e:
            print(f"ì‚¬ì´íŠ¸ë§µ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: {str(e)}")
        EOF
        
    - name: Request URL indexing (for new/updated pages)
      run: |
        python << 'EOF'
        import json
        import os
        import subprocess
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        
        # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        def get_changed_files():
            try:
                result = subprocess.run(['git', 'diff', '--name-only', 'HEAD~1'], 
                                      capture_output=True, text=True)
                return result.stdout.strip().split('\n') if result.stdout.strip() else []
            except:
                return []
        
        # ì„œë¹„ìŠ¤ ê³„ì • ì¸ì¦ (Indexing API ì‚¬ìš©)
        SCOPES = ['https://www.googleapis.com/auth/indexing']
        SERVICE_ACCOUNT_FILE = 'service-account-key.json'
        
        credentials = service_account.Credentials.from_service_account_file(
            SERVICE_ACCOUNT_FILE, scopes=SCOPES)
        
        service = build('indexing', 'v3', credentials=credentials)
        
        site_url = '${{ secrets.SITE_URL }}'
        changed_files = get_changed_files()
        
        # HTML/MD íŒŒì¼ë§Œ í•„í„°ë§
        relevant_files = [f for f in changed_files 
                         if f.endswith(('.html', '.md')) and not f.startswith('.')]
        
        print(f"ðŸ” ë³€ê²½ëœ ê´€ë ¨ íŒŒì¼: {relevant_files}")
        
        for file_path in relevant_files[:10]:  # ìµœëŒ€ 10ê°œ íŒŒì¼ë§Œ ì²˜ë¦¬
            # íŒŒì¼ ê²½ë¡œë¥¼ URLë¡œ ë³€í™˜
            if file_path.endswith('.md'):
                url_path = file_path.replace('.md', '.html')
            else:
                url_path = file_path
                
            full_url = f"{site_url.rstrip('/')}/{url_path.lstrip('/')}"
            
            try:
                body = {
                    'url': full_url,
                    'type': 'URL_UPDATED'
                }
                
                request = service.urlNotifications().publish(body=body)
                response = request.execute()
                print(f"âœ… ìƒ‰ì¸ ìš”ì²­ ì„±ê³µ: {full_url}")
                
            except Exception as e:
                print(f"âŒ ìƒ‰ì¸ ìš”ì²­ ì‹¤íŒ¨ ({full_url}): {str(e)}")
        EOF
        
    - name: Clean up
      if: always()
      run: |
        rm -f service-account-key.json
        
    - name: Create summary
      run: |
        echo "## ðŸ” Google Search Console ì—…ë°ì´íŠ¸ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "- ì‚¬ì´íŠ¸ë§µ ì œì¶œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "- ë³€ê²½ëœ íŽ˜ì´ì§€ ìƒ‰ì¸ ìš”ì²­ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "- ì‹¤í–‰ ì‹œê°„: $(date)" >> $GITHUB_STEP_SUMMARY